# Rule-based detection rules for LLM Agents

rules:
  # LLM-specific rules
  # High CPU usage
  - name: high_cpu_usage
    description: CPU usage exceeds 90%
    anomaly_type: performance
    severity: 0.8
    logic: AND
    conditions:
      - metric: cpu_usage
        operator: ">"
        value: 90.0
        description: CPU usage above 90%

  # High memory usage
  - name: high_memory_usage
    description: Memory usage exceeds 85%
    anomaly_type: performance
    severity: 0.7
    logic: AND
    conditions:
      - metric: memory_usage
        operator: ">="
        value: 85.0
        description: Memory usage above 85%

  # Very high response time
  - name: high_response_time
    description: Response time exceeds threshold
    anomaly_type: performance
    severity: 0.8
    logic: AND
    conditions:
      - metric: response_time_ms
        operator: ">"
        value: 1000.0
        description: Response time above 1 second

  # Error rate spike
  - name: high_error_rate
    description: Error rate exceeds 5%
    anomaly_type: communication
    severity: 0.9
    logic: AND
    conditions:
      - metric: error_rate
        operator: ">"
        value: 0.05
        description: Error rate above 5%

  # Multiple conditions: High CPU AND High Memory
  - name: resource_exhaustion
    description: Both CPU and memory usage are high
    anomaly_type: performance
    severity: 0.9
    logic: AND
    conditions:
      - metric: cpu_usage
        operator: ">"
        value: 80.0
      - metric: memory_usage
        operator: ">"
        value: 80.0

  # Time-windowed rule: High error rate sustained
  - name: sustained_high_errors
    description: High error rate sustained over 5 minutes
    anomaly_type: communication
    severity: 0.85
    logic: AND
    time_window_seconds: 300  # 5 minutes
    min_occurrences: 3
    conditions:
      - metric: error_rate
        operator: ">"
        value: 0.03
        description: Error rate above 3%

  # Throughput drop
  - name: low_throughput
    description: Throughput below normal
    anomaly_type: performance
    severity: 0.6
    logic: AND
    conditions:
      - metric: requests_per_second
        operator: "<"
        value: 10.0
        description: Less than 10 requests per second

  # LLM-specific rules
  
  # High token usage
  - name: high_token_usage
    description: Token usage exceeds threshold
    anomaly_type: token_usage
    severity: 0.8
    logic: AND
    conditions:
      - metric: total_tokens
        operator: ">"
        value: 50000
        description: More than 50,000 tokens per request
  
  # Very high latency
  - name: very_high_latency
    description: Response latency too high
    anomaly_type: latency
    severity: 0.9
    logic: AND
    conditions:
      - metric: latency_ms
        operator: ">"
        value: 60000
        description: More than 60 seconds latency
  
  # High cost per request
  - name: high_cost_per_request
    description: Cost per request exceeds threshold
    anomaly_type: cost
    severity: 0.8
    logic: AND
    conditions:
      - metric: cost_usd
        operator: ">"
        value: 0.50
        description: More than $0.50 per request
  
  # Quality degradation
  - name: quality_degradation
    description: Quality score dropped significantly
    anomaly_type: quality
    severity: 0.7
    logic: AND
    conditions:
      - metric: quality_score
        operator: "<"
        value: 0.6
        description: Quality score below 0.6
  
  # Hallucination detected
  - name: hallucination_detected
    description: Hallucination detected in response
    anomaly_type: quality
    severity: 0.9
    logic: AND
    conditions:
      - metric: hallucination_detected
        operator: "=="
        value: true
        description: Hallucination flag is true
  
  # Context window almost full
  - name: context_window_high
    description: Context window usage is very high
    anomaly_type: context_overflow
    severity: 0.8
    logic: AND
    conditions:
      - metric: context_window_usage
        operator: ">"
        value: 0.90
        description: Context window usage above 90%

