# Изменения для поддержки LLM-агентов

## Обзор изменений

Система обнаружения аномалий была переработана для мониторинга **LLM-агентов** — автономных систем на базе больших языковых моделей (Large Language Models), способных воспринимать окружение, планировать действия и достигать целей без жесткого программирования.

## Новые возможности

### 1. LLM-специфичные типы аномалий

Добавлены новые типы аномалий в `AnomalyType`:
- `TOKEN_USAGE` - Аномальное использование токенов
- `LATENCY` - Аномальная задержка ответа
- `COST` - Аномальные расходы на API
- `QUALITY` - Падение качества ответов
- `RATE_LIMIT` - Превышение лимитов API
- `CONTEXT_OVERFLOW` - Переполнение контекстного окна

### 2. Классы для LLM-агентов

**Новый модуль:** `anomaly_detection/core/llm_agent.py`

- `LLMAgent` - Класс для представления LLM-агента
  - Поддержка различных моделей (GPT-4, Claude, Gemini и др.)
  - Метаданные о провайдере, модели, лимитах
  - Конфигурация контекстного окна

- `LLMAgentMetrics` - Структура метрик для LLM-агентов
  - Метрики токенов (input/output/total)
  - Задержка (latency_ms)
  - Стоимость (cost_usd)
  - Качество (quality_score, coherence_score, relevance_score)
  - Обнаружение галлюцинаций и ошибок
  - Использование контекстного окна
  - Rate limits

- `LLMProvider` и `LLMModel` - Enum'ы для типизации

### 3. LLM-специфичные детекторы

**Новый модуль:** `anomaly_detection/detectors/llm_detector.py`

#### TokenUsageDetector
- Обнаружение скачков использования токенов
- Контроль максимального количества токенов
- Обнаружение неэффективного использования (высокий input/output ratio)

#### LatencyDetector
- Мониторинг времени ответа
- Обнаружение аномальных задержек
- Статистический анализ трендов

#### CostDetector
- Отслеживание стоимости запросов
- Контроль дневного бюджета
- Обнаружение скачков стоимости

#### QualityDetector
- Мониторинг качества ответов
- Обнаружение галлюцинаций
- Отслеживание фактологических ошибок
- Контроль coherence и relevance scores

#### RateLimitDetector
- Мониторинг rate limits
- Предупреждения при приближении к лимитам
- Обнаружение превышения лимитов

#### ContextOverflowDetector
- Мониторинг использования контекстного окна
- Предупреждения при высоком использовании
- Критические алерты при приближении к переполнению

### 4. Обновленная конфигурация

**config/config.yaml:**
- Новый раздел `detectors.llm` с настройками всех LLM-детекторов
- Параметры по умолчанию для каждого детектора

**config/rules.yaml:**
- Добавлены правила для LLM-специфичных метрик
- Примеры правил для токенов, latency, cost, quality

**config/agents.yaml.example:**
- Обновлены примеры конфигураций для LLM-агентов
- Добавлены метаданные о моделях и провайдерах

### 5. Примеры использования

**examples/llm_agent_example.py:**
- Базовый пример работы с LLM-агентом
- Демонстрация различных типов аномалий

**examples/llm_agent_simulator.py:**
- Симулятор LLM-агентов
- Генерация различных типов аномалий
- Тестирование всех детекторов

### 6. Обновленная документация

- README.md обновлен с описанием LLM-специфичных возможностей
- Добавлены примеры метрик и конфигураций
- Описание новых типов аномалий

## Обратная совместимость

Система сохраняет полную обратную совместимость:
- Существующие детекторы (Statistical, ML, RuleBased, TimeSeries) работают как прежде
- Стандартные типы аномалий (BEHAVIORAL, PERFORMANCE и др.) остались без изменений
- API остался прежним, добавлены только новые опциональные детекторы

## Миграция существующих систем

Для использования LLM-специфичных возможностей:

1. Обновите конфигурацию, добавив раздел `detectors.llm`
2. Используйте класс `LLMAgent` вместо `Agent` (опционально)
3. Добавьте LLM-специфичные метрики в ваши агенты
4. Настройте правила в `rules.yaml` для LLM-метрик

## Новые зависимости

Дополнительных зависимостей не требуется - используются те же библиотеки, что и в базовой версии.

## Пример миграции

### Было:
```python
from anomaly_detection import AnomalyDetectionSystem

system = AnomalyDetectionSystem()
agent = system.register_agent(
    agent_id='agent_1',
    metadata={'name': 'My Agent'}
)
```

### Стало (с LLM-поддержкой):
```python
from anomaly_detection import AnomalyDetectionSystem, LLMAgent

system = AnomalyDetectionSystem(config='config/config.yaml')
agent = system.register_agent(
    agent_id='gpt4_chatbot',
    metadata={
        'model': 'gpt-4',
        'provider': 'openai',
        'context_window_size': 8192
    }
)
```

Метрики теперь могут включать LLM-специфичные поля:
```python
metrics = {
    "input_tokens": 1500,
    "output_tokens": 800,
    "latency_ms": 2500.0,
    "cost_usd": 0.04,
    "quality_score": 0.92,
    # ... и другие LLM-метрики
}
```

## Следующие шаги

- Интеграция с OpenAI/Anthropic/Google API для автоматического сбора метрик
- Поддержка автоматического обнаружения галлюцинаций через внешние сервисы
- Расширенная аналитика качества ответов
- Интеграция с системами управления бюджетами

