# Архитектура системы обнаружения аномалий для LLM-агентов

## Обзор архитектуры

Система построена по модульной архитектуре, обеспечивающей расширяемость, масштабируемость и возможность горизонтального развертывания. Архитектура следует принципам разделения ответственности и инверсии зависимостей.

```
┌─────────────────────────────────────────────────────────────┐
│                    AnomalyDetectionSystem                    │
│                  (Главный координатор)                       │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   Registry   │ │   Alert      │ │  Metrics     │
│              │ │   Manager    │ │  Collector   │
└──────────────┘ └──────────────┘ └──────────────┘
        │              │              │
        └──────────────┼──────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   Agent      │ │  Detectors   │ │     API      │
│   Monitor    │ │  (Multiple)  │ │  (REST/WS)   │
└──────────────┘ └──────────────┘ └──────────────┘
```

## Основные компоненты

### 1. Core Layer (Ядро системы)

#### 1.1. Anomaly (`core/anomaly.py`)
**Ответственность:** Представление данных об аномалиях

```python
@dataclass
class Anomaly:
    agent_id: str
    anomaly_type: AnomalyType
    severity: float  # 0.0 - 1.0
    timestamp: datetime
    description: str
    detector_name: str
    metrics: Dict[str, Any]
    metadata: Dict[str, Any]
```

**Типы аномалий:**
- Общие: `BEHAVIORAL`, `PERFORMANCE`, `COMMUNICATION`, `TEMPORAL`, `SEMANTIC`
- LLM-специфичные: `TOKEN_USAGE`, `LATENCY`, `COST`, `QUALITY`, `RATE_LIMIT`, `CONTEXT_OVERFLOW`

#### 1.2. AnomalyDetector (`core/detector.py`)
**Ответственность:** Абстрактный базовый класс для всех детекторов

```python
class AnomalyDetector(ABC):
    @abstractmethod
    def detect(agent_id, metrics, historical_data) -> List[Anomaly]
    def fit(data) -> None  # Опционально
    def reset() -> None    # Опционально
```

**Принципы:**
- Единый интерфейс для всех детекторов
- Поддержка обучения на исторических данных
- Возможность сброса состояния

#### 1.3. Agent & LLMAgent (`core/monitor.py`, `core/llm_agent.py`)
**Ответственность:** Представление агентов

```python
class Agent:
    agent_id: str
    metrics_endpoint: Optional[str]
    metadata: Dict
```

```python
class LLMAgent(Agent):
    model: str
    provider: str
    context_window_size: Optional[int]
    rate_limit: Optional[int]
```

#### 1.4. AgentMonitor (`core/monitor.py`)
**Ответственность:** Мониторинг отдельного агента

```python
class AgentMonitor:
    agent: Agent
    detectors: List[AnomalyDetector]
    metrics_collector: Callable
```

**Поток работы:**
1. Сбор метрик от агента
2. Запуск всех детекторов
3. Возврат списка обнаруженных аномалий
4. Сохранение истории метрик

### 2. Detectors Layer (Слой детекторов)

Детекторы реализуют различные алгоритмы обнаружения аномалий.

#### 2.1. Statistical Detector (`detectors/statistical.py`)
**Методы:**
- Z-score анализ
- Interquartile Range (IQR)
- Скользящее среднее с отклонением

**Использование:** Быстрое обнаружение статистических выбросов

#### 2.2. ML Detector (`detectors/ml.py`)
**Методы:**
- Isolation Forest
- One-Class SVM

**Особенности:**
- Обучение на исторических данных
- Поддержка онлайн-обучения
- Многомерный анализ

#### 2.3. Rule-Based Detector (`detectors/rule_based.py`)
**Возможности:**
- Конфигурируемые правила (YAML)
- Композитные условия (AND/OR)
- Временные окна
- Пороги встречаемости

**Пример:**
```yaml
- name: high_token_usage
  conditions:
    - metric: total_tokens
      operator: ">"
      value: 50000
  logic: AND
```

#### 2.4. Time Series Detector (`detectors/timeseries.py`)
**Методы:**
- Анализ трендов
- Сезонные паттерны
- Prophet (опционально)

#### 2.5. LLM-Specific Detectors (`detectors/llm_detector.py`)

**TokenUsageDetector:**
- Обнаружение скачков использования токенов
- Контроль максимального лимита
- Выявление неэффективного использования

**LatencyDetector:**
- Мониторинг времени ответа
- Обнаружение аномальных задержек

**CostDetector:**
- Отслеживание стоимости запросов
- Контроль дневного бюджета
- Обнаружение скачков стоимости

**QualityDetector:**
- Мониторинг качества ответов
- Обнаружение галлюцинаций
- Отслеживание фактологических ошибок

**RateLimitDetector:**
- Мониторинг rate limits
- Предупреждения при приближении к лимитам

**ContextOverflowDetector:**
- Мониторинг использования контекстного окна
- Предупреждения о переполнении

### 3. Management Layer (Слой управления)

#### 3.1. AnomalyRegistry (`management/registry.py`)
**Ответственность:**
- Хранение всех обнаруженных аномалий
- Дедупликация схожих аномалий
- Приоритизация по серьезности
- Фильтрация и поиск

**Особенности:**
- Индексирование по agent_id и anomaly_type
- Временное окно для дедупликации
- Автоматическая очистка старых данных

#### 3.2. AlertManager (`management/alert_manager.py`)
**Ответственность:**
- Управление уведомлениями
- Поддержка различных каналов
- Шаблонизация сообщений
- Cooldown периоды

**Поддерживаемые каналы:**
- Console (по умолчанию)
- Slack (через webhook)
- Email (требует настройки)
- Telegram (требует настройки)
- Webhook (универсальный)

**Особенности:**
- Настраиваемые правила алертинга
- Эскалация при отсутствии реакции
- Шаблоны сообщений

#### 3.3. MetricsCollector (`management/metrics_collector.py`)
**Ответственность:**
- Сбор метрик от агентов
- Хранение исторических данных
- Агрегация метрик

**Хранение:**
- In-memory (по умолчанию)
- Возможность расширения до БД (TimescaleDB, InfluxDB)

**Функции:**
- История метрик с временными фильтрами
- Агрегация (average, sum, min, max, latest)
- Очистка старых данных

### 4. System Layer (Системный слой)

#### 4.1. AnomalyDetectionSystem (`system/system.py`)
**Ответственность:** Главный координатор всей системы

**Основные функции:**
- Регистрация и управление агентами
- Инициализация детекторов из конфигурации
- Координация мониторинга
- Интеграция всех компонентов

**Поток работы:**
```
1. Инициализация системы
   ├─ Загрузка конфигурации
   ├─ Инициализация компонентов (Registry, AlertManager, MetricsCollector)
   └─ Инициализация детекторов

2. Регистрация агентов
   ├─ Создание Agent/LLMAgent
   ├─ Создание AgentMonitor для агента
   └─ Назначение детекторов

3. Запуск мониторинга
   ├─ Асинхронный цикл сбора метрик
   ├─ Запуск детекторов
   ├─ Регистрация аномалий
   └─ Отправка алертов

4. Обработка аномалий
   ├─ Дедупликация в Registry
   ├─ Приоритизация
   └─ Отправка через AlertManager
```

### 5. API Layer (Слой API)

#### 5.1. REST API (`api/rest_api.py`)
**Технология:** FastAPI

**Endpoints:**
- `GET /` - Информация о системе
- `POST /agents/register` - Регистрация агента
- `GET /agents` - Список агентов
- `GET /agents/{agent_id}` - Информация об агенте
- `POST /agents/{agent_id}/check` - Ручная проверка
- `GET /anomalies` - Список аномалий (с фильтрами)
- `GET /agents/{agent_id}/stats` - Статистика по агенту
- `GET /stats` - Общая статистика
- `POST /monitoring/start` - Запуск мониторинга
- `POST /monitoring/stop` - Остановка мониторинга
- `GET /health` - Health check
- `GET /metrics` - Prometheus метрики

#### 5.2. WebSocket API (`api/rest_api.py`)
**Endpoint:** `WS /ws/anomalies`

**Назначение:** Real-time уведомления об аномалиях

#### 5.3. Prometheus Exporter (`api/prometheus.py`)
**Ответственность:** Экспорт метрик в формате Prometheus

**Метрики:**
- `anomalies_detected_total` - Счетчик аномалий
- `anomaly_severity` - Гистограмма серьезности
- `agents_monitored` - Количество агентов
- `active_anomalies` - Активные аномалии

## Потоки данных

### Поток 1: Сбор метрик и обнаружение

```
Agent → MetricsCollector → AgentMonitor → Detectors → Anomalies
                                                              │
                                                              ▼
                                                       AnomalyRegistry
                                                              │
                                                              ▼
                                                       AlertManager → Channels
```

### Поток 2: Запрос аномалий через API

```
Client → REST API → AnomalyDetectionSystem → Registry → Filtered Anomalies → Client
```

### Поток 3: Real-time уведомления

```
AgentMonitor → AnomalyRegistry → AlertManager → WebSocket → Client
```

## Архитектурные паттерны

### 1. Strategy Pattern
Каждый детектор реализует общий интерфейс `AnomalyDetector`, позволяя динамически выбирать алгоритмы обнаружения.

### 2. Observer Pattern
AlertManager подписывается на события обнаружения аномалий и уведомляет зарегистрированные каналы.

### 3. Repository Pattern
AnomalyRegistry инкапсулирует логику хранения и поиска аномалий.

### 4. Factory Pattern
AnomalyDetectionSystem создает детекторы на основе конфигурации.

### 5. Chain of Responsibility
Несколько детекторов последовательно анализируют метрики, каждый может обнаружить свои аномалии.

## Масштабирование

### Горизонтальное масштабирование

Система поддерживает горизонтальное масштабирование через:

1. **Разделение агентов:** Разные инстансы могут мониторить разных агентов
2. **Shared Registry:** Использование общей БД для хранения аномалий
3. **Message Queue:** Интеграция с очередями сообщений для распределенной обработки

### Вертикальное масштабирование

- Асинхронная обработка (asyncio)
- Батчинг запросов к детекторам
- Кэширование часто используемых данных
- Оптимизация алгоритмов детекторов

## Конфигурация

### Структура конфигурации

```yaml
# config/config.yaml
collection_interval_seconds: 10
deduplication_window_minutes: 5

detectors:
  statistical: {...}
  ml: {...}
  rule_based: {...}
  timeseries: {...}
  llm:
    token_usage: {...}
    latency: {...}
    cost: {...}
    quality: {...}
    rate_limit: {...}
    context_overflow: {...}

alerts: {...}
metrics: {...}
```

### Загрузка конфигурации

1. Основной файл `config.yaml`
2. Правила в `rules.yaml`
3. Агенты в `agents.yaml`
4. Возможность переопределения через параметры

## Обработка ошибок

### Стратегия обработки ошибок

1. **Изоляция ошибок:** Ошибка в одном детекторе не останавливает другие
2. **Логирование:** Все ошибки логируются с контекстом
3. **Graceful degradation:** Система продолжает работать при частичных сбоях
4. **Retry механизмы:** Для сетевых запросов (метрики, алерты)

## Производительность

### Оптимизации

1. **Векторизованные вычисления:** Использование NumPy
2. **Асинхронный I/O:** asyncio для всех сетевых операций
3. **Батчинг:** Группировка запросов к детекторам
4. **Кэширование:** История метрик в памяти
5. **Ленивая инициализация:** Детекторы инициализируются по требованию

### Производительность (целевые показатели)

- Задержка обнаружения: < 1 секунда
- Пропускная способность: 10K+ метрик/сек
- Потребление памяти: минимальное
- CPU использование: оптимизировано

## Безопасность

### Текущие меры

1. **Валидация входных данных:** Pydantic модели
2. **Изоляция агентов:** Отдельные мониторы для каждого агента
3. **Безопасное хранение:** API ключи в метаданных (рекомендуется использовать секреты)

### Рекомендации

1. Использовать переменные окружения для секретов
2. HTTPS для всех API endpoints
3. Аутентификация и авторизация для REST API
4. Валидация всех входных данных

## Расширяемость

### Добавление нового детектора

```python
from anomaly_detection.core.detector import AnomalyDetector

class CustomDetector(AnomalyDetector):
    def detect(self, agent_id, metrics, historical_data):
        # Ваша логика
        return [anomaly1, anomaly2]

system.add_detector(CustomDetector(name="custom"))
```

### Добавление нового канала алертов

```python
async def custom_handler(anomaly, message):
    # Ваша логика отправки
    pass

alert_manager.register_handler(AlertChannel.CUSTOM, custom_handler)
```

### Интеграция с внешними системами

Система может быть интегрирована с:
- **TimescaleDB/InfluxDB** - для долгосрочного хранения метрик
- **Grafana** - для визуализации (через Prometheus)
- **Slack/Teams** - для уведомлений
- **Message Queues** - для распределенной обработки

## Тестирование

### Стратегия тестирования

1. **Unit тесты:** Каждый компонент тестируется изолированно
2. **Integration тесты:** Проверка взаимодействия компонентов
3. **Примеры:** Рабочие примеры в папке `examples/`

### Симуляторы

- `agent_simulator.py` - Симулятор обычных агентов
- `llm_agent_simulator.py` - Симулятор LLM-агентов

## Развертывание

### Docker

```yaml
# docker-compose.yml
services:
  anomaly-detection: {...}
  prometheus: {...}
  grafana: {...}
```

### Kubernetes

Система может быть развернута в Kubernetes с:
- Horizontal Pod Autoscaler
- ConfigMaps для конфигурации
- Secrets для API ключей
- Service для API endpoints

## Диаграмма компонентов

```
┌─────────────────────────────────────────────────────────┐
│              AnomalyDetectionSystem                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  Registry   │  │   Alert     │  │   Metrics   │    │
│  │             │  │   Manager   │  │  Collector  │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
           │                │                │
           └────────────────┼────────────────┘
                            │
           ┌────────────────┼────────────────┐
           │                │                │
    ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐
    │   Agent     │  │  Detectors  │  │     API     │
    │   Monitor   │  │             │  │             │
    │             │  │ - Statistical│  │ - REST API  │
    │ - Agent     │  │ - ML        │  │ - WebSocket │
    │ - History   │  │ - RuleBased │  │ - Prometheus│
    │             │  │ - TimeSeries│  │             │
    │             │  │ - LLM       │  │             │
    └─────────────┘  └─────────────┘  └─────────────┘
```

## Заключение

Архитектура системы обеспечивает:

✅ **Модульность** - Легко добавлять новые детекторы и компоненты  
✅ **Масштабируемость** - Поддержка горизонтального и вертикального масштабирования  
✅ **Производительность** - Оптимизирована для реального времени  
✅ **Расширяемость** - Простое добавление новых функций  
✅ **Надежность** - Изоляция ошибок и graceful degradation  

Система спроектирована для работы в продакшене с тысячами LLM-агентов.

